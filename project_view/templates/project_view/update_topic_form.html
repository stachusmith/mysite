{% extends "base_menu.html" %}
{% load crispy_forms_tags %}
{% block head %}
<style>
:root {
        --box-width: 28%;
        --box-height: 200px;
    }
.target {
    width: var(--box-width);
    height: var(--box-height);
    padding: 5px;
    margin: 1em;
    border-width: 1px;
    border-style: solid;
    border-color: black;
    border-radius: 5px;
    background-color: rgb(246, 246, 246);
}#picture_box {
    width: var(--box-width);
    height: var(--box-height);
    padding: 5px;
    margin: 1em;
    border-width: 1px;
    border-style: solid;
    border-color: black;
    border-radius: 5px;
    background-color: rgb(246, 246, 246);
}
.picture_detail {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    display: none;
    background-color: rgba(0,0,0,0.5);
}
.trash-text {
    position: absolute;
    transform: translate(-12px, calc(var(--box-height) * 0.95));
}
</style>
{% endblock %}

{% block content %}
<div id="target_list">
    {% if picture_list %}

        {% for picture in picture_list %}
            
            <a href="#"><img type="image" id=picture_box
                src="{% url 'project_view:picture_stream' topic.id picture.id %}" 
                onclick="document.getElementById('picture_detail{{ picture.id}}').style.display= 'block';"><!--picture detail appears-->
            </a>

            <div id='picture_detail{{ picture.id}}' class="picture_detail" onclick="document.getElementById('picture_detail{{ picture.id}}').style.display= 'none';"><a href="#">
                <img type="image"  src="{% url 'project_view:picture_stream' topic.id picture.id %}" 
                style="position: fixed; max-width: 100%; height: auto; left: 50%; top: 50%; transform: translate(-50%, -50%);"><!--picture detail disappears-->
            </a></div>
            
            
            {% if part.owner == user %}
                <a class="trash-text" href="{% url 'project_view:picture_delete' topic.id picture.id %}"><i class="fa fa-trash"></i></a>
            {% endif %}
            
        {% endfor %}

    {% endif %}


</div>
<p style="margin-left: 1em;">paste image here:</p>
<p><img type="image" class="target" id="target" value="paste picture here"></p>

<p>
  <form action="" method="post" id="upload_form" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form|crispy }}
    
    <input type="submit" value="Submit">
    <input type="submit" value="Cancel" onclick="window.location.href='{% url 'project_view:topic_cancel' topic.id %}';return false;">
  </form>
</p>

<div><p>
    
{% if entries_list %}

    {% for entry in entries_list %}
        <p>
            {{ entry.date_of_entry }}
            {{ entry.solution }}
            
            {% for responsible_list in reponsibilities_lists %}
                {% for person in responsible_list %}
                    {{ person.participant.name }}
                {% endfor %}
            {% endfor %}
            {{ entry.involved }}
            {{ entry.agreed_with}}
            {{ entry.deadline }}
            <span style="float: right;">
            {% if topic.owner == user %}
                <a href="{% url 'project_view:topic_entry_update' entry.topic.part.id entry.topic.id entry.id %}"><i class="fa fa-pencil"></i></a> 
                <a href="{% url 'project_view:entry_delete' entry.id %}"><i class="fa fa-trash"></i></a>
            {% endif %}
            </span>
        </p>
    {% endfor %}
</p>
</p>
{% else %}
<p>
    there are no entries for this topic
</p>

{% endif %}
</p></div>


{% if update == 1 %}
    <p>

        <form action="{% url 'project_view:entry_update' entry.id %}" method="post" id="entry_form">
        {% csrf_token %}
        {{ entry_form|crispy }}
        <input type="submit" for="entry_form" value="Save entry">
        </form>
    </p>
{% else %}
    <p>
        <form action="{% url 'project_view:entry_create' topic.id %}" method="post" id="entry_form">
        {% csrf_token %}
        {{ entry_form|crispy }}
        <input type="submit" for="entry_form" value="Save entry">
        </form>
    </p>
{% endif %}

<script>
document.onpaste = function (pasteEvent) {
    //create new target:
    var t = document.getElementById("target")
    var cloneT = t.cloneNode(true)
    document.getElementById("target_list").appendChild(cloneT); 
    //pull image items from clipboard:
    var items = pasteEvent.clipboardData.items;
    typeCheck= /^image.*/;
    test = typeCheck.test(items[0].type);
    if (test === true) {
        var blob = items[0].getAsFile();
        //load to target:
        var reader = new FileReader();
        reader.onload = function (loadEvent) {
            document.getElementById("target").src = loadEvent.target.result;
        }
        reader.readAsDataURL(blob);
        //send picture to db using fetch:
        var myForm = document.getElementById("target");
        var formData = new FormData();
        var myUrl = "{% url 'project_view:picture_add' topic.id %}";


        formData.append("inpFile", blob);
        
        fetch(myUrl, {
            method: "post",
            body: formData
        }).then(function(data){
            console.log(data)
        }).catch(console.log(myUrl, 'error'));
    }


    
    

    
};
</script>
{% endblock %}