{% extends "base_menu.html" %}
{% load crispy_forms_tags %}
{% block head %}
<style>
:root {
        --box-width: 28%;
        --box-height: 200px;
    }
.target {
    width: var(--box-width);
    height: var(--box-height);
    padding: 5px;
    margin: 1em;
    border-width: 1px;
    border-style: solid;
    border-color: black;
    border-radius: 5px;
    background-color: rgb(246, 246, 246);
}#picture_box {
    width: var(--box-width);
    height: var(--box-height);
    padding: 5px;
    margin: 1em;
    border-width: 1px;
    border-style: solid;
    border-color: black;
    border-radius: 5px;
    background-color: rgb(246, 246, 246);
}
.picture_detail {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10;
    display: none;
    background-color: rgba(0,0,0,0.5);
}
.trash-text {
    position: absolute;
    transform: translate(-12px, calc(var(--box-height) * 0.95));
}
</style>
{% endblock %}

{% block content %}

<H1>{{ topic.title }}</H1>


<div id="target_list">
    {% if picture_list %}

        {% for picture in picture_list %}
            
            <a href="#"><img type="image" id=picture_box
                src="{% url 'project_view:picture_stream' topic.id picture.id %}" 
                onclick="document.getElementById('picture_detail{{ picture.id}}').style.display= 'block';"><!--picture detail appears-->
            </a>

            <div id='picture_detail{{ picture.id}}' class="picture_detail" onclick="document.getElementById('picture_detail{{ picture.id}}').style.display= 'none';"><a href="#">
                <img type="image"  src="{% url 'project_view:picture_stream' topic.id picture.id %}" 
                style="position: fixed; max-width: 100%; height: auto; left: 50%; top: 50%; transform: translate(-50%, -50%);"><!--picture detail disappears-->
            </a></div>
            
            
            {% if part.owner == user %}
                <a class="trash-text" href="{% url 'project_view:picture_delete' topic.id picture.id %}"><i class="fa fa-trash"></i></a>
            {% endif %}
            
        {% endfor %}

    {% endif %}


</div>
<p style="margin-left: 1em;">paste image here:</p>
<p><img type="image" class="target" id="target" value="paste picture here"></p>

<p>
  <form action="" method="post" id="upload_form" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form|crispy }}
    
    <input type="submit" value="Submit">
    <input type="submit" value="Cancel" onclick="window.location.href='{% url 'project_view:topic_cancel' topic.id %}';return false;">
  </form>
</p>

<div id="entry_list"><p>
    
{% if entries_list %}

    {% for entry in entries_list %}
        <p>
            {{ entry.date_of_entry }}
            {{ entry.solution }}
            {% for person in entry.responsible.all %}
                {{ person }}
            {% endfor %}
            {% for person in entry.involved.all %}
                {{ person }}
            {% endfor %}
            {% for person in entry.agreed_with.all %}
                {{ person }}
            {% endfor %}
            

            {{ entry.deadline }}
            <span style="float: right;">
            {% if topic.owner == user %}
                <a href="{% url 'project_view:topic_entry_update' entry.topic.part.id entry.topic.id entry.id %}"><i class="fa fa-pencil"></i></a> 
                <a href="{% url 'project_view:entry_delete' entry.id %}"><i class="fa fa-trash"></i></a>
            {% endif %}
            </span>
        </p>
    {% endfor %}
</p>
</p>
{% else %}
<p>
    there are no entries for this topic
</p>

{% endif %}
</p></div>


{% if update == 1 %}
    <p>

        <form action="{% url 'project_view:entry_update' entry.id %}" method="post" id="entry_form">
        {% csrf_token %}
        {{ entry_form|crispy }}
        <input type="submit" for="entry_form" value="Update entry">
        <input type="submit" value="Cancel" onclick="window.location.href='{% url 'project_view:topic_update' part.id topic.id %}'; return false;">
        </form>
    </p>
{% else %}
    <p>
        <form action="{% url 'project_view:entry_create' topic.id %}" method="post" id="entry_form">
        {% csrf_token %}
        {{ entry_form|crispy }}
        <input type="submit" for="entry_form" value="Create entry">
        </form>
    </p>
{% endif %}

<script>
document.onpaste = function (pasteEvent) {
    
    //create new target html element for next picture:
    var t = document.getElementById("target")
    var cloneT = t.cloneNode(true)
    document.getElementById("target_list").appendChild(cloneT); 
    
    //input for desired picture with. further resize operations
    //below at reSize function
    var resize_width=1000 // no px

    //pull image items from clipboard:
    var items = pasteEvent.clipboardData.items;
    //check data type of clipboard for image
    typeCheck= /^image.*/;
    test = typeCheck.test(items[0].type);
    console.log(items[0]);
    if (test === true) {
        var blob = items[0].getAsFile();//get the image as a file
        console.log(blob)
        /*load to target html element and turn image
        to base64-encoded Data URI*/
        var reader = new FileReader();

        //reading/rendering the content of the the blob is triggered:
        reader.readAsDataURL(blob);
        reader.name = blob.name
        //upon loading the reader, the resize function is triggered
        reader.onload = function (theBlobLoad) {
            var img = new Image(); //set up new image
            img.src = theBlobLoad.target.result //set src of new image to base64-encoded Data URI 
            img.name = theBlobLoad.target.name
            img.size = theBlobLoad.target.size
            img.onload = function reSize(image) {
                var myCanvas = document.createElement('canvas');//create a canvas
                originalWidth=image.srcElement.naturalWidth;
                originalHeight=image.srcElement.naturalHeight;
                var picRatio = resize_width / originalWidth;
                myCanvas.width = resize_width;
                myCanvas.height = originalHeight * picRatio;
                console.log(myCanvas.width, myCanvas.height, picRatio, originalWidth)

                //draw in canvas
                var myCanvasContent = myCanvas.getContext('2d');
                myCanvasContent.drawImage(image.target, 0, 0, myCanvas.width, myCanvas.height);
                console.log(myCanvasContent)
                //get the base64-encoded Data URI from the resize image
                var srcEncoded = myCanvasContent.canvas.toDataURL(image.target, 'image/jpeg', 0);
                console.log(srcEncoded)
                
                //upon loading the file-reader the target html element's src attribute is set
                //the file reader will now knows where render the image
                //result is base64-encoded Data URI
                document.getElementById("target").src = srcEncoded;
                var resized = document.getElementById("target").src;
                console.log("resized:",resized); //correct dims but only base64
                

                function dataURLtoFile(dataurl, filename) {
 
                var arr = dataurl.split(','),
                    mime = arr[0].match(/:(.*?);/)[1],
                    bstr = atob(arr[1]), 
                    n = bstr.length, 
                    u8arr = new Uint8Array(n);
                    
                while(n--){
                    u8arr[n] = bstr.charCodeAt(n);
                }
                
                return new File([u8arr], filename, {type:mime});
                }
                //image.target.src = srcEncoded
                var file = dataURLtoFile(srcEncoded, 'reducedImage.png')
                console.log('newFile:',file)
                console.log('image.target', image.target.width);
                console.log('image.srcElement',image.srcElement.width);
                
                /*prepare data to be sent to server*/
                var formData = new FormData();
                var myUrl = "{% url 'project_view:picture_add' topic.id %}";//target url on server side
                formData.append("inpFile", file); //(name of data, data)
                /*prepare data to be sent to server*/

                /*send the data using fetch method:*/
                fetch(myUrl, {
                    method: "post",
                    body: formData
                }).then(function(data){
                    console.log(data)
                }).catch(console.log(myUrl, 'error'));
                
            }
            
            
        }
        //console.log("resized_outside_2:",resized);


        console.log('target_element',document.getElementById('target').src)
        var resizedImg = document.getElementById('target').src;
        console.log('resizedImg',resizedImg)

        
    }
};
//position window to list of entries upon page load:
window.onload = function () {
    document.getElementById('entry_list').scrollIntoView();
}
</script>
{% endblock %}